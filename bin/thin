#!/usr/bin/env ruby

# Command:
#   thin start [-e developement]
#   thin restart
#   thin stop
#   thin stop --all
#   thin status

require "fileutils"

class Thin
  public
    def status
      sleep 0.5
      puts ""
      puts "    " + ("-" * 100)
      puts `ps aux | grep "[t]hin server\\|[P]ID"`.strip.gsub(/^/, "    ")
      puts "    " + ("-" * 100)
    end
    
    def start
      puts "Start Thin server.\n\n"
      `thin #{ARGV.join(" ")} -d`
      status
    end
    
    def restart
      puts "Restart Thin server.\n\n"
      puts "    Not running." if pids.size == 0
      pids.each do |file|
        pid = File.read(file)
        puts "    PID = #{pid}"
        `kill -HUP #{pid}` if `ps aux | grep "thin [s]erver" | grep #{pid}`.strip != ""
      end
      status
    end
    
    def stop
      return stop_all if ARGV.index("--all")
      
      puts "Stop Thin server.\n\n"
      puts "    Not running." if pids.size == 0
      pids.each do |file|
        pid = File.read(file)
        puts "    PID = #{pid}"
        `kill -9 #{pid}` if `ps aux | grep "[t]hin server" | grep #{pid}`.strip != ""
        FileUtils.rm_rf file
      end
      status
    end
    
    def stop_all
      puts "Stop all Thin servers."
      `pkill -KILL -f "thin server"`
      status
    end
    
  private
    def pids
      return @pids if @pids
      @pids = Dir.glob("#{File.dirname(__dir__)}/tmp/pids/*.pid")
    end
end

Thin.new.send ARGV[0]
puts ""
