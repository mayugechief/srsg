<%

last = nil
categories = Category::Node.site(@cur_site).my_route.select do |cate|
  if last == nil
    last = cate
  elsif cate.filename =~ /^#{last.filename}\//
    false
  else
    last = cate
  end
end

def cate_form(item)
  h  = %Q[<label style="margin-right: 10px;">]
  h << check_box_tag("item[category_ids][]", item._id, @item.category_ids.include?(item._id))
  h << %Q[#{item.name}</label>]
  
  children = Category::Node.site(@cur_site).my_route
  children = children.where(filename: /^#{item.filename}\//, depth: item.depth + 1)
  
  if children.size > 0
    h << %Q[<div style="padding: 0px 0px 0px 40px;">].html_safe
    children.each { |c| h += cate_form c }
    h << %Q[</div>].html_safe
  end
  
  h.html_safe
end

%>
<dl class="see">
  <dt class="wide">Category</dt>
  <dd class="wide" style="line-height: 2.5">
    <%= hidden_field_tag "item[category_ids][]" %>
    
    <% categories.each do |cate| %>
    <div style="padding: 10px 5px; border-top: 1px solid #ccc;"><%= cate_form cate %></div>
    <% end %>
  </dd>
</dl>
